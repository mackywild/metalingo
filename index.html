<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="skull.png">
  <title>METALINGO</title>
  <style>
    /* ãƒ†ãƒ¼ãƒ */
    :root {
      --bg: #0b0b0f;
      --accent: #e11d48;
      --ink: #e5e7eb;
      --muted: #9ca3af;
    }

    html,
    body {
      height: 100%;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      color: var(--ink);
      background: radial-gradient(1200px 800px at 70% -10%, #2b0008 0%, transparent 40%),
        radial-gradient(900px 600px at 20% 120%, #18041d 0%, transparent 50%),
        linear-gradient(180deg, #0a0a0d 0%, #050507 100%);
      background-color: var(--bg);
      overflow-x: hidden;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
    header {
      text-align: center;
      padding: 24px 12px 8px;
    }

    .logo {
      display: inline-flex;
      gap: 14px;
      align-items: center;
      user-select: none;
    }

    .skull {
      width: 42px;
      height: 42px;
      filter: drop-shadow(0 0 8px rgba(225, 29, 72, .55));
    }

    .title {
      font-family: Impact, Haettenschweiler, "Arial Black", fantasy;
      letter-spacing: 1px;
      font-size: clamp(28px, 5vw, 56px);
      color: #fff;
      text-shadow: 0 0 6px rgba(225, 29, 72, .6), 0 0 24px rgba(162, 28, 175, .45), 0 2px 0 #000;
    }

    .subtitle {
      margin-top: 6px;
      color: var(--muted);
      font-size: 12px;
      letter-spacing: .2em;
    }

    /* ãƒ‘ãƒãƒ«ï¼†ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 12px;
    }

    .panel {
      background: linear-gradient(180deg, #17171e 0%, #111118 100%);
      border: 1px solid #2b2b36;
      border-radius: 18px;
      padding: 18px;
      position: relative;
      box-shadow: 0 8px 40px rgba(0, 0, 0, .45), inset 0 1px 0 rgba(255, 255, 255, .04);
    }

    .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }

    .btn {
      appearance: none;
      border: 1px solid #4b1020;
      border-radius: 14px;
      padding: 12px 18px;
      font-weight: 800;
      letter-spacing: .06em;
      cursor: pointer;
      background: conic-gradient(from 200deg at 50% 50%, rgba(225, 29, 72, .5), rgba(162, 28, 175, .5)) border-box, linear-gradient(180deg, #1a0e14, #0e0a12) padding-box;
      color: #fff;
      box-shadow: 0 10px 24px rgba(225, 29, 72, .15), inset 0 1px 0 rgba(255, 255, 255, .08);
    }

    .btn:disabled {
      opacity: .5;
      cursor: not-allowed;
    }

    .stage {
      display: grid;
      grid-template-columns: 1.2fr .9fr;
      gap: 18px;
      align-items: stretch;
    }

    @media (max-width:980px) {
      .stage {
        grid-template-columns: 1fr;
      }
    }

    /* ç¾åœ¨ãƒ»å±¥æ­´ãƒ»ãƒ—ãƒ¼ãƒ« */
    .now {
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: Impact, Haettenschweiler, "Arial Black", fantasy;
      font-size: clamp(60px, 12vw, 160px);
      line-height: 1;
      min-height: 210px;
      letter-spacing: .02em;
      background: radial-gradient(600px 240px at 50% -40%, rgba(225, 29, 72, .18), transparent 60%), linear-gradient(180deg, #0b0b10, #15151f);
      border: 1px solid #2a2a35;
      border-radius: 16px;
      position: relative;
      text-shadow: 0 0 24px rgba(225, 29, 72, .35);
    }

    .now .label {
      position: absolute;
      top: 10px;
      left: 12px;
      font-size: 12px;
      color: var(--muted);
    }

    .sparks {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .spark {
      position: absolute;
      width: 2px;
      height: 12px;
      background: linear-gradient(180deg, #fff, rgba(255, 255, 255, 0));
      opacity: .9;
      transform: rotate(var(--r, 0deg));
      filter: drop-shadow(0 0 6px rgba(225, 29, 72, .9));
    }

    .history {
      display: grid;
      grid-template-columns: repeat(8, minmax(36px, 1fr));
      gap: 6px;
      margin-top: 12px;
    }

    .ball {
      aspect-ratio: 1/1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      border: 1px solid #2a2a35;
      background: radial-gradient(120px 120px at 30% 30%, #262633, #12121a);
      color: #8f98a8;
      font-weight: 700;
      text-shadow: 0 1px 0 #000;
      box-shadow: inset 0 12px 24px rgba(0, 0, 0, .55);
    }

    .ball.hit {
      border-color: var(--accent);
      color: #fff;
      font-size: 50px;
      background: radial-gradient(140px 140px at 30% 30%, #3a0b16, #0f0b10);
      box-shadow: 0 0 0 2px rgba(225, 29, 72, .15), inset 0 12px 24px rgba(0, 0, 0, .7);
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 6px;
      margin-top: 12px;
    }

    .grid .cell {
      aspect-ratio: 1/1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      border-radius: 10px;
      border: 1px solid #2a2a35;
      background: #0e0e14;
      color: #8b92a1;
    }

    .grid .cell.mark {
      color: #fff;
      border-color: var(--accent);
      background: radial-gradient(120px 120px at 30% 30%, #3a0b16, #0e0b11);
      box-shadow: 0 0 0 1px rgba(225, 29, 72, .2);
    }

    footer {
      margin: 28px 0 40px;
      text-align: center;
      color: var(--muted);
      font-size: 12px;
    }

    /* â€”â€” æ™¯å“ç®¡ç†ï¼†ãƒ¢ãƒ¼ãƒ€ãƒ« â€”â€” */
    .admin-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    @media (max-width: 980px) {
      .admin-grid {
        grid-template-columns: 1fr;
      }
    }

    .input,
    .textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #2b2b36;
      background: #0e0e14;
      color: #e5e7eb;
    }

    .textarea {
      min-height: 96px;
      resize: vertical;
    }

    .prize-preview {
      width: 100%;
      max-height: 220px;
      object-fit: cover;
      border-radius: 12px;
      border: 1px solid #2b2b36;
      background: #0e0e14;
    }

    .prize-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .prize-card {
      border: 1px solid #2b2b36;
      border-radius: 14px;
      overflow: hidden;
      background: linear-gradient(180deg, #17171e, #111118);
    }

    .prize-card img {
      width: 100%;
      aspect-ratio: 4/3;
      object-fit: cover;
      display: block;
    }

    .prize-card .body {
      padding: 10px 12px;
    }

    .prize-card .name {
      font-weight: 800;
      margin-bottom: 4px;
    }

    .prize-card .desc {
      font-size: 12px;
      color: #9ca3af;
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .badge {
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #2b2b36;
      color: #9ca3af;
      font-size: 12px;
    }

    /* â€”â€” å±¥æ­´ â€”â€” */
    .history-wrap {
      margin-top: 12px;
    }

    .history-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 8px;
    }

    .history-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
    }

    .h-card {
      border: 1px solid #2b2b36;
      border-radius: 12px;
      overflow: hidden;
      background: linear-gradient(180deg, #17171e, #111118);
    }

    .h-card img {
      width: 100%;
      aspect-ratio: 4/3;
      object-fit: cover;
      display: block;
    }

    .h-body {
      padding: 10px;
    }

    .h-title {
      font-weight: 800;
    }

    .h-sub {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 4px;
    }

    .badge-num {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid #2b2b36;
      margin-right: 6px;
    }

    /* â€”â€” é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ç™ºè¡¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ â€”â€” */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .modal.show {
      display: flex;
    }

    .dialog {
      width: min(1000px, 92vw);
      max-height: 85vh;
      overflow: auto;
      background: linear-gradient(180deg, #17171e, #111118);
      border: 1px solid #2b2b36;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, .6);
    }

    .dialog .head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .picker-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
    }

    .announce {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      background: radial-gradient(900px 600px at 50% -10%, rgba(225, 29, 72, .25), transparent 40%), rgba(0, 0, 0, .8);
    }

    .announce.show {
      display: flex;
    }

    .announce .board {
      width: min(1100px, 92vw);
      background: linear-gradient(180deg, #17171e, #0f0f16);
      border: 2px solid #e11d48;
      border-radius: 20px;
      padding: 18px;
      text-align: center;
      box-shadow: 0 0 40px rgba(225, 29, 72, .25);
    }

    .announce .title {
      font-family: Impact, Haettenschweiler, "Arial Black", fantasy;
      font-size: clamp(28px, 5vw, 42px);
      letter-spacing: .06em;
      margin-bottom: 10px;
    }

    .announce img {
      width: 100%;
      max-height: 56vh;
      object-fit: contain;
      border-radius: 14px;
      border: 1px solid #2b2b36;
    }

    .announce .desc {
      margin-top: 10px;
      color: #e5e7eb;
    }

    .announce .hint {
      margin-top: 8px;
      font-size: 12px;
      color: #9ca3af;
    }

    /* ç”»åƒç›´ä¸‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
    .announce .msg {
      margin-top: 10px;
      font-weight: 900;
      font-size: clamp(22px, 3.6vw, 32px);
      letter-spacing: .06em;
      color: #fff;
      text-shadow: 0 0 6px rgba(225, 29, 72, .6), 0 0 20px rgba(162, 28, 175, .35), 0 2px 0 #000;
      animation: popIn 300ms ease-out;
    }

    @keyframes popIn {
      from {
        transform: scale(.92);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* â€”â€” ãƒã‚¿ãƒãƒ¬é˜²æ­¢ã‚µãƒ ãƒ â€”â€” */
    .mystery-thumb {
      width: 100%;
      aspect-ratio: 4/3;
      border-radius: 12px;
      border: 1px solid #2b2b36;
      background:
        radial-gradient(140% 100% at 30% -10%, rgba(225, 29, 72, .18), transparent 35%),
        linear-gradient(180deg, #17171e, #111118);
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      box-shadow: inset 0 12px 24px rgba(0, 0, 0, .45);
    }

    .mystery-thumb .q {
      font-weight: 900;
      font-size: clamp(24px, 6vw, 44px);
      letter-spacing: .12em;
      color: #fff;
      text-shadow: 0 0 10px rgba(225, 29, 72, .5), 0 2px 0 #000;
    }

    .mystery-hint {
      font-size: 12px;
      color: #9ca3af;
      margin-top: 6px;
    }
  </style>
</head>

<body>
  <header>
    <div class="logo">
      <img src="skull.png" alt="Skull Logo" class="skull">
      <div class="title">METALINGO</div>
      <img src="skull.png" alt="Skull Logo" class="skull">
    </div>
    <div class="subtitle">ãƒ¡ã‚¿ãƒ©ãƒ¼ãŒä½œã£ãŸãƒ“ãƒ³ã‚´ã‚²ãƒ¼ãƒ </div>
  </header>

  <main class="wrap">
    <section class="panel" id="host">
      <div class="controls" style="margin-bottom:12px">
        <div class="callout">çŠ¶æ…‹ï¼š<span id="status">æœªé–‹å§‹</span></div>
        <div style="flex:1"></div>
        <button class="btn" id="btnStartStop">æŠ½é¸é–‹å§‹</button>
        <button class="btn" id="btnReset">ãƒªã‚»ãƒƒãƒˆ</button>
        <button class="btn" id="btnBingo">ãƒ“ãƒ³ã‚´</button>
        <button class="btn" id="System">ç®¡ç†è€…</button>
      </div>

      <div class="stage">
        <div style="position:relative">
          <div class="now" id="now">
            <div class="label">ç¾åœ¨ã®ãƒœãƒ¼ãƒ«</div>
            <span id="nowNum">â€“</span>
            <div class="sparks" id="sparks"></div>
          </div>
          <div style="margin-top:12px">
            <div class="callout">å±¥æ­´</div>
            <div class="history" id="history"></div>
          </div>
        </div>
        <div>
          <div class="callout">æŠ½é¸ãƒ—ãƒ¼ãƒ«</div>
          <div class="grid" id="pool"></div>
        </div>
      </div>
    </section>
    <section class="panel" id="prizeAdmin" hidden="hidden">
      <div class="row" style="justify-content:space-between; margin-bottom:10px;">
        <div class="callout">æ™¯å“ç®¡ç†</div>
        <div class="row" style="gap:8px">
          <span class="badge" id="prizeCountBadge">0/30</span>
          <button class="btn" id="pzRevealReset" type="button" title="å…¬é–‹çŠ¶æ…‹ã ã‘åˆæœŸåŒ–">
            ç”»åƒå…¬é–‹ãƒªã‚»ãƒƒãƒˆ
          </button>
        </div>
      </div>

      <div class="admin-grid">
        <div>
          <label>æ™¯å“å</label>
          <input id="pzName" class="input" placeholder="ä¾‹ï¼‰ç‰¹è³ï¼šé«˜ç´šã‚³ãƒ¼ãƒ’ãƒ¼ãƒ¡ãƒ¼ã‚«ãƒ¼">
          <label style="margin-top:8px; display:block;">èª¬æ˜</label>
          <textarea id="pzDesc" class="textarea" placeholder="ä»•æ§˜ã‚„é­…åŠ›ã€å—ã‘å–ã‚Šæ–¹æ³•ãªã©"></textarea>

          <div class="row" style="margin-top:8px;">
            <input id="pzImgUrl" class="input" placeholder="ç”»åƒURLï¼ˆä»»æ„ã€‚ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã©ã¡ã‚‰ã‹ï¼‰">
          </div>
          <div class="row" style="margin-top:6px;">
            <input id="pzImgFile" type="file" accept="image/*">
            <button class="btn" id="pzRegBtn" type="button">ç™»éŒ²</button>
            <button class="btn" id="pzClearBtn" type="button" title="å…¨å‰Šé™¤">å…¨å‰Šé™¤</button>
          </div>

          <img id="pzPreview" class="prize-preview" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" style="margin-top:8px;">
        </div>

        <div hidden="hidden">
          <div class="callout">ç™»éŒ²æ¸ˆã¿</div>
          <div id="prizeList" class="prize-list"></div>
        </div>
      </div>
    </section>

    <!-- æ™¯å“é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="prizePicker" class="modal" aria-hidden="true">
      <div class="dialog">
        <div class="head">
          <div class="callout">å½“é¸æ™¯å“ã‚’é¸æŠ</div>
          <button class="btn" id="pickerClose" type="button">é–‰ã˜ã‚‹</button>
        </div>
        <div id="pickerGrid" class="picker-grid"></div>
      </div>
    </div>

    <!-- ç™ºè¡¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div id="prizeAnnounce" class="announce" aria-hidden="true">
      <div class="board">
        <div class="title">ğŸ‰ å½“é¸ãŠã‚ã§ã¨ã†ï¼ ğŸ‰</div>
        <img id="announceImg" alt="æ™¯å“ç”»åƒ">
        <div id="announceMsg" class="msg">å½“é¸ãŠã‚ã§ã¨ã†ï¼</div> <!-- ç”»åƒç›´ä¸‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
        <div id="announceName" class="title" style="margin-top:10px; font-size: clamp(22px,4vw,32px);"></div>
        <div id="announceDesc" class="desc"></div>
        <div class="hint">ï¼ˆã‚¯ãƒªãƒƒã‚¯/ESCã§é–‰ã˜ã‚‹ï¼‰</div>
      </div>
    </div>

    <!-- å½“é¸å±¥æ­´ -->
    <section class="panel" id="prizeHistoryPanel" hidden="hidden">
      <div class="row" style="justify-content:space-between; margin-bottom:10px;">
        <div class="callout">å½“é¸å±¥æ­´</div>
        <div class="history-actions">
          <button class="btn" id="histClear" type="button">å…¨ã‚¯ãƒªã‚¢</button>
        </div>
      </div>
      <div class="history-wrap">
        <div id="historyGridPrize" class="history-grid"></div>
      </div>
    </section>
    <div style="height:24px">
      <form action="https://formspree.io/f/xkgpzvnb" method="POST">
        <label>
          æ¬²ã—ã„æ©Ÿèƒ½ã‚„æ”¹å–„ç‚¹ã‚’æ•™ãˆã¦ãã ã•ã„:
          <textarea name="message"></textarea>
        </label>
        <!-- your other form fields go here -->
        <button type="submit">é€ä¿¡</button>
      </form>
    </div>
  </main>

  <footer>Creater:Mackywild 2025ã€ŒMetal Never Dieã€</footer>

  <script>
    // DOM 
    const $ = (q, root = document) => root.querySelector(q);
    const $$ = (q, root = document) => Array.from(root.querySelectorAll(q));

    // è¦ç´ å‚ç…§
    const poolEl = $('#pool');
    const historyEl = $('#history');
    const nowNumEl = $('#nowNum');
    const statusEl = $('#status');
    const sparksEl = $('#sparks');

    // çŠ¶æ…‹
    const MODE = 75;
    let pool = [], remain = [], history = [], rollTimer = null;
    let sysFlg = false;

    // åˆæœŸåŒ–
    function init() {
      pool = Array.from({ length: MODE }, (_, i) => i + 1);
      remain = pool.slice();
      history = [];
      nowNumEl.textContent = 'â€“';
      renderPool();
      renderHistory();
      statusEl.textContent = 'æœªé–‹å§‹';
      // $('#btnStop').disabled = true; $('#btnStart').disabled = false;
      btnStartStop.textContent = 'æŠ½é¸é–‹å§‹';
      btnStartStop.disabled = false;
      btnBingo.disabled = false;
      btnReset.disabled = false;
    }

    // ãƒ—ãƒ¼ãƒ«æç”»
    function renderPool() {
      poolEl.innerHTML = '';
      pool.forEach(n => {
        const d = document.createElement('div');
        d.className = 'cell' + (history.includes(n) ? ' mark' : '');
        d.textContent = n;
        poolEl.appendChild(d);
      });
    }

    // å±¥æ­´æç”»
    function renderHistory() {
      historyEl.innerHTML = '';
      history.slice().reverse().forEach(n => {
        const b = document.createElement('div');
        b.className = 'ball hit'; b.textContent = n; historyEl.appendChild(b);
      });
    }

    // ç«èŠ±ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    function burstSparks() {
      sparksEl.innerHTML = '';
      for (let i = 0; i < 36; i++) {
        const s = document.createElement('div'); s.className = 'spark';
        s.style.left = 50 + (Math.random() * 30 - 15) + '%';
        s.style.top = '45%';
        s.style.setProperty('--r', Math.random() * 360 + 'deg');
        const vy = (Math.random() * 80 + 140) * (Math.random() > .5 ? -1 : 1);
        const vx = (Math.random() * 220 - 110);
        const dur = 600 + Math.random() * 400; const start = performance.now();
        function anim(t) {
          const p = (t - start) / dur; if (p >= 1) { s.remove(); return; }
          const y = vy * p * p, x = vx * p;
          s.style.transform = `translate(${x}px, ${y}px) rotate(var(--r))`;
          s.style.opacity = String(1 - p);
          requestAnimationFrame(anim);
        }
        sparksEl.appendChild(s);
        requestAnimationFrame(anim);
      }
    }

    // ãƒŸãƒ¥ãƒ¼ã‚¸ãƒƒã‚¯(ä»Šå›ã¯è‡ªä½œãƒãƒƒãƒ—ã‚¹ã§æŒ™å‹•ã®ã¿æ¤œè¨¼) 
    const MetalSound = (() => {
      let audio;

      function start() {
        // ã™ã§ã«å†ç”Ÿä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„
        if (audio && !audio.paused) return;
        audio = new Audio("image Pop Step.wav");
        audio.volume = 0.5;
        audio.loop = true;  // ãƒ«ãƒ¼ãƒ—å†ç”Ÿ
        audio.play().catch(err => console.warn("éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:", err));
      }

      function stop() {
        if (audio) {
          audio.pause();   // åœæ­¢
          audio.currentTime = 0; // å†ç”Ÿä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
        }
      }

      return { start, stop };
    })();

    //  ãƒœã‚¿ãƒ³å‹•ä½œ 
    const btnStartStop = $('#btnStartStop');
    const btnReset = $('#btnReset');
    const btnBingo = $('#btnBingo');
    const btnSystem = $('#System');

    // çŠ¶æ…‹ç®¡ç†
    let isRolling = false;
    let lastDecided = null; // å±¥æ­´ç”¨ã«ç¢ºå®šç•ªå·ã‚’ä¿æŒ


    // æŠ½é¸é–‹å§‹ãƒ»åœæ­¢ãƒˆã‚°ãƒ«
    btnStartStop.addEventListener('click', () => {
      if (!isRolling) {
        // === æŠ½é¸é–‹å§‹ ===
        if (remain.length === 0) {
          alert('ã™ã¹ã¦æŠ½é¸æ¸ˆã¿ã§ã™');
          return;
        }
        statusEl.textContent = 'æŠ½é¸ä¸­â€¦';
        btnStartStop.textContent = 'STOP / æ±ºå®š';
        btnBingo.disabled = true;
        btnReset.disabled = true;
        MetalSound.start();

        rollTimer = setInterval(() => {
          const n = remain[Math.floor(Math.random() * remain.length)];
          nowNumEl.textContent = n;
        }, 40);

        isRolling = true;
      } else {
        // === ã‚¹ãƒˆãƒƒãƒ—ãƒ»æ±ºå®š ===
        clearInterval(rollTimer);
        rollTimer = null;
        MetalSound.stop();

        const n = Number(nowNumEl.textContent);
        lastDecided = n;
        const ri = remain.indexOf(n);
        if (ri > -1) remain.splice(ri, 1);
        if (!history.includes(n)) history.push(n);

        statusEl.textContent = `æ±ºå®šï¼š${n}ï¼ˆæ®‹ã‚Š ${remain.length}ï¼‰`;
        renderPool();
        renderHistory();
        burstSparks();

        btnStartStop.textContent = 'æŠ½é¸é–‹å§‹';
        btnBingo.disabled = false;
        btnReset.disabled = false;
        isRolling = false;
      }
    });

    btnReset.addEventListener('click', () => {
      if (confirm('ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿå±¥æ­´ãŒæ¶ˆãˆã¾ã™')) init();
    });

    btnBingo.addEventListener('click', () => { })

    btnSystem.addEventListener('click', () => {
      if (sysFlg == false) {
        document.getElementById("prizeAdmin").hidden = false;
        document.getElementById("prizeHistoryPanel").hidden = false;
        sysFlg = true;

      } else {
        document.getElementById("prizeAdmin").hidden = true;
        document.getElementById("prizeHistoryPanel").hidden = true;
        sysFlg = false;
      }

    })

    /* ===== æ™¯å“ç™»éŒ²ï¼‹é¸æŠç™ºè¡¨ï¼‹å±¥æ­´ ===== */
    const MAX_PRIZES = 30;
    const PRIZE_KEY = 'metalingo_prizes_v1';
    const PRIZE_HIST_KEY = 'metalingo_prize_history_v1';

    // ç®¡ç†UI
    const prizeCountBadge = document.getElementById('prizeCountBadge');
    const prizeListEl = document.getElementById('prizeList');
    const pzName = document.getElementById('pzName');
    const pzDesc = document.getElementById('pzDesc');
    const pzImgUrl = document.getElementById('pzImgUrl');
    const pzImgFile = document.getElementById('pzImgFile');
    const pzPreview = document.getElementById('pzPreview');
    const pzRegBtn = document.getElementById('pzRegBtn');
    const pzClearBtn = document.getElementById('pzClearBtn');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼†ç™ºè¡¨
    const prizePicker = document.getElementById('prizePicker');
    const pickerGrid = document.getElementById('pickerGrid');
    const pickerClose = document.getElementById('pickerClose');
    const announceEl = document.getElementById('prizeAnnounce');
    const announceImg = document.getElementById('announceImg');
    const announceMsg = document.getElementById('announceMsg');
    const announceName = document.getElementById('announceName');
    const announceDesc = document.getElementById('announceDesc');

    // å±¥æ­´UI
    const historyGridPrize = document.getElementById('historyGridPrize');
    const histClear = document.getElementById('histClear');

    // util
    function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2, 8); }
    function fmtTime(ts) { const d = new Date(ts); return `${d.getFullYear()}/${d.getMonth() + 1}/${d.getDate()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`; }

    // storage
    function loadPrizes() { try { return JSON.parse(localStorage.getItem(PRIZE_KEY) || '[]'); } catch { return []; } }
    function savePrizes(arr) { localStorage.setItem(PRIZE_KEY, JSON.stringify(arr)); }
    function loadHist() { try { return JSON.parse(localStorage.getItem(PRIZE_HIST_KEY) || '[]'); } catch { return []; } }
    function saveHist(arr) { localStorage.setItem(PRIZE_HIST_KEY, JSON.stringify(arr)); }

    // å®‰å…¨è¦ç´ ç”Ÿæˆï¼ˆXSSè»½æ¸›ï¼‰
    function el(tag, props = {}, children = []) {
      const d = document.createElement(tag);
      for (const [k, v] of Object.entries(props)) {
        if (k === 'text') d.textContent = v;
        else if (k === 'src') d.setAttribute('src', v);
        else d.setAttribute(k, v);
      }
      children.forEach(c => d.appendChild(c));
      return d;
    }

    function cardForPrizeList(p) {
      const img = p.img ? el('img', { src: p.img, alt: '' }) : null;
      if (img) img.onerror = () => img.remove();
      const name = el('div', { class: 'name', text: p.name });
      const desc = el('div', { class: 'desc', text: p.desc || '' });
      const del = el('button', { class: 'btn' }, []); del.textContent = 'å‰Šé™¤';
      del.addEventListener('click', () => { savePrizes(loadPrizes().filter(x => x.id !== p.id)); renderPrizeList(); });
      const row = el('div', { class: 'row' }, [del]);
      const body = el('div', { class: 'body' }, [name, desc, row]);
      const card = el('div', { class: 'prize-card' }, []);
      if (img) card.appendChild(img);
      card.appendChild(body);
      return card;
    }

    function renderPrizeList() {
      // â˜… revealed æœªå®šç¾©ãªã‚‰ false ã«æƒãˆã‚‹(æ—§ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ)
      const normalized = loadPrizes().map(p => ({ revealed: false, ...p }));
      savePrizes(normalized);

      const prizes = normalized;
      prizeListEl.innerHTML = '';
      prizes.forEach(p => prizeListEl.appendChild(cardForPrizeList(p)));
      if (prizeCountBadge) prizeCountBadge.textContent = `${prizes.length}/${MAX_PRIZES}`;
      pzRegBtn.disabled = prizes.length >= MAX_PRIZES;
    }

    function updatePreview() {
      const url = pzImgUrl.value.trim();
      const file = pzImgFile.files && pzImgFile.files[0];
      if (file) {
        const r = new FileReader();
        r.onload = e => pzPreview.src = e.target.result;
        r.readAsDataURL(file);
      } else if (url) {
        pzPreview.src = url;
      } else {
        pzPreview.removeAttribute('src');
      }
    }
    pzImgUrl.addEventListener('input', updatePreview);
    pzImgFile.addEventListener('change', updatePreview);

    pzRegBtn.addEventListener('click', async () => {
      const prizes = loadPrizes();
      if (prizes.length >= MAX_PRIZES) { alert(`ä¸Šé™${MAX_PRIZES}ä»¶ã¾ã§`); return; }
      const name = pzName.value.trim(); if (!name) { alert('æ™¯å“åã¯å¿…é ˆ'); return; }
      const desc = pzDesc.value.trim();
      const url = pzImgUrl.value.trim();
      const file = pzImgFile.files && pzImgFile.files[0];

      let imgData = '';
      if (file) {
        imgData = await new Promise((res, rej) => {
          const r = new FileReader();
          r.onload = e => res(e.target.result);
          r.onerror = rej;
          r.readAsDataURL(file);
        });
      } else if (url) { imgData = url; }

      prizes.push({ id: uid(), name, desc, img: imgData, revealed: false }); // â˜…è¿½åŠ 
      savePrizes(prizes);

      pzName.value = ''; pzDesc.value = ''; pzImgUrl.value = ''; pzImgFile.value = '';
      pzPreview.removeAttribute('src');
      renderPrizeList();
    });

    pzClearBtn.addEventListener('click', () => {
      if (!confirm('ç™»éŒ²æ¸ˆã¿æ™¯å“ã‚’å…¨å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ï¼Ÿ')) return;
      savePrizes([]); renderPrizeList();
    });

    // å±¥æ­´
    function renderHist() {
      const arr = loadHist().slice().reverse();
      historyGridPrize.innerHTML = '';
      if (arr.length === 0) {
        const d = el('div', { class: 'h-sub', text: 'ã¾ã å½“é¸å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚' });
        historyGridPrize.appendChild(d); return;
      }
      arr.forEach(x => {
        const wrap = el('div', { class: 'h-card' });
        if (x.img) {
          const im = el('img', { src: x.img, alt: '' }); im.onerror = () => im.remove();
          wrap.appendChild(im);
        }
        const ttl = el('div', { class: 'h-title' });
        if (x.num) { ttl.appendChild(el('span', { class: 'badge-num', text: `#${x.num}` })); }
        ttl.appendChild(document.createTextNode(x.name));

        const meta = el('div', { class: 'h-sub', text: fmtTime(x.ts) });
        const dsc = x.desc ? el('div', { class: 'h-sub', text: x.desc }) : null;
        const body = el('div', { class: 'h-body' }, dsc ? [ttl, meta, dsc] : [ttl, meta]);
        wrap.appendChild(body);
        historyGridPrize.appendChild(wrap);
      });
    }
    function pushHist(entry) {
      const arr = loadHist();
      arr.push(entry);
      saveHist(arr);
      renderHist();
    }
    histClear.addEventListener('click', () => {
      if (!confirm('å½“é¸å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ï¼Ÿ')) return;
      saveHist([]);
      renderHist();
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼†ç™ºè¡¨
    function openPicker() {
      const prizes = loadPrizes().map(p => ({ revealed: false, ...p })); // ä¿é™º
      pickerGrid.innerHTML = '';
      if (prizes.length === 0) {
        pickerGrid.appendChild(el('div', { style: 'color:#9ca3af', text: 'æ™¯å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å³ã®ã€Œæ™¯å“ç®¡ç†ã€ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚' }));
      } else {
        prizes.forEach(p => {
          const card = el('div', { class: 'prize-card' });

          if (p.revealed && p.img) {
            // â˜… å…¬é–‹æ¸ˆã¿ã¯æœ¬ç‰©ã®ç”»åƒã‚’å‡ºã™
            const im = el('img', { src: p.img, alt: '' }); im.onerror = () => im.remove();
            card.appendChild(im);
          } else {
            // â˜… æœªå…¬é–‹ã¯ãƒã‚¿ãƒãƒ¬é˜²æ­¢ã‚µãƒ ãƒã‚’å‡ºã™
            const mystery = el('div', { class: 'mystery-thumb' }, [
              el('div', { class: 'q', text: 'ï¼Ÿï¼Ÿï¼Ÿ' })
            ]);
            card.appendChild(mystery);
          }

          const name = el('div', { class: 'name', text: p.name });
          const desc = el('div', { class: 'desc', text: (p.desc || '').slice(0, 80) });
          const hint = !p.revealed ? el('div', { class: 'mystery-hint', text: 'ç™ºè¡¨ã¾ã§ç”»åƒã¯ãƒ’ãƒŸãƒ„' }) : null;

          const choose = el('button', { class: 'btn' });
          choose.textContent = 'ã“ã®æ™¯å“ã‚’ç™ºè¡¨';
          choose.addEventListener('click', () => showAnnouncement(p));

          const bodyKids = hint ? [name, desc, hint] : [name, desc];
          const body = el('div', { class: 'body' }, [...bodyKids, el('div', { class: 'row' }, [choose])]);

          card.appendChild(body);
          pickerGrid.appendChild(card);
        });
      }
      prizePicker.classList.add('show');
      prizePicker.setAttribute('aria-hidden', 'false');
      pickerClose.focus();
    }

    function closePicker() {
      prizePicker.classList.remove('show');
      prizePicker.setAttribute('aria-hidden', 'true');
    }

    pickerClose.addEventListener('click', closePicker);
    prizePicker.addEventListener('click', (e) => { if (e.target === prizePicker) closePicker(); });

    function showAnnouncement(prize) {
      closePicker();
      announceName.textContent = prize.name;
      announceDesc.textContent = prize.desc || '';
      announceMsg.textContent = 'å½“é¸ãŠã‚ã§ã¨ã†ï¼';
      if (prize.img) { announceImg.src = prize.img; } else { announceImg.removeAttribute('src'); }
      announceEl.classList.add('show'); announceEl.setAttribute('aria-hidden', 'false');

      // â˜… ã“ã“ã§å…¬é–‹ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
      const arr = loadPrizes();
      const i = arr.findIndex(x => x.id === prize.id);
      if (i > -1) { arr[i].revealed = true; savePrizes(arr); }

      // å±¥æ­´ã«è¨˜éŒ²
      pushHist({ ts: Date.now(), num: lastDecided, id: prize.id, name: prize.name, desc: prize.desc || '', img: prize.img || '' });
    }
    function hideAnnouncement() { announceEl.classList.remove('show'); announceEl.setAttribute('aria-hidden', 'true'); }
    announceEl.addEventListener('click', hideAnnouncement);
    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') hideAnnouncement(); });

    /* ===== btnBingo ã®å®‰å…¨ãƒã‚¤ãƒ³ãƒ‰ï¼ˆææ¡ˆâ‘ ï¼šremoveâ†’addï¼‰ ===== */
    function onBingoClick() { openPicker(); }
    function bindBingo() {
      const el = document.getElementById('btnBingo'); if (!el) return;
      el.removeEventListener('click', onBingoClick);
      el.addEventListener('click', onBingoClick, { passive: true });
    }

    /* ç”»åƒå…¬é–‹ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½å®Ÿè£…*/
    const pzRevealReset = document.getElementById('pzRevealReset');
    pzRevealReset.addEventListener('click', () => {
      if (!confirm('ã™ã¹ã¦ã®æ™¯å“ã®ã€Œå…¬é–‹æ¸ˆã¿ã€çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ï¼Ÿ')) return;
      const arr = loadPrizes().map(p => ({ ...p, revealed: false }));
      savePrizes(arr);
      renderPrizeList();
      // ãƒ”ãƒƒã‚«ãƒ¼ã‚’é–‹ã„ã¦ã„ãŸå ´åˆã‚‚åæ˜ ã—ãŸã„ãªã‚‰å†æç”»
      if (prizePicker.classList.contains('show')) openPicker();
    });
    bindBingo();
    init();

    /* åˆæœŸæç”»ï¼ˆæœ€å¾Œã«ï¼‰ */
    renderPrizeList();
    renderHist();

  </script>
</body>

</html>